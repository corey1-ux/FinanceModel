<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Professional DCF Model with Live Data</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden}
.header{background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:2.5rem;font-weight:300;margin-bottom:10px}
.header p{font-size:1.1rem;opacity:.9}
.main-content{display:grid;grid-template-columns:1fr 1fr;gap:30px;padding:30px}
.input-column{display:flex;flex-direction:column;gap:25px}
.input-section{background:#f8f9fa;padding:25px;border-radius:10px;border-left:4px solid #3498db}
.results-section{background:#f8f9fa;padding:25px;border-radius:10px;border-left:4px solid #27ae60}
.section-title{font-size:1.4rem;color:#2c3e50;margin-bottom:20px;font-weight:600}
.input-group{margin-bottom:15px}
.input-group label{display:block;margin-bottom:8px;color:#555;font-weight:500;font-size:.9rem}
.input-group input,.input-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;transition:border-color .3s}
.input-group input:focus,.input-group select:focus{outline:none;border-color:#3498db}
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.fetch-btn,.calculate-btn{width:100%;background:linear-gradient(135deg,#3498db 0%,#2980b9 100%);color:#fff;border:none;padding:15px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:transform .2s;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:10px}
.fetch-btn:hover,.calculate-btn:hover{transform:translateY(-2px)}
.fetch-btn:disabled{background:#95a5a6;cursor:not-allowed;transform:none}
.loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:none}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.scenario-tabs{display:flex;margin-bottom:20px;background:#e9ecef;border-radius:8px;padding:4px}
.scenario-tab{flex:1;padding:10px;text-align:center;border-radius:6px;cursor:pointer;font-weight:600;transition:all .3s}
.scenario-tab.active{background:#3498db;color:#fff}
.scenario-content{display:none}
.scenario-content.active{display:block}
.result-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#fff;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.result-label{font-weight:600;color:#555}
.result-value{font-weight:700;font-size:1.1rem;color:#2c3e50}
.valuation-summary{background:linear-gradient(135deg,#27ae60 0%,#229954 100%);color:#fff;padding:20px;border-radius:10px;text-align:center;margin-top:20px}
.valuation-summary h3{font-size:1.3rem;margin-bottom:10px}
.valuation-summary .price{font-size:2rem;font-weight:700}
.valuation-summary .positive{color:#c8e6c9}
.valuation-summary .negative{color:#ffcdd2}
.scenarios-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px}
.scenario-result{background:#fff;padding:15px;border-radius:8px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.scenario-result h4{color:#555;margin-bottom:10px}
.scenario-result .value{font-size:1.5rem;font-weight:700;color:#2c3e50}
.cash-flow-table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.cash-flow-table th,.cash-flow-table td{padding:12px;text-align:right;border-bottom:1px solid #eee;font-size:.9rem}
.cash-flow-table th{background:#f1f2f6;font-weight:600;color:#555}
.cash-flow-table tr:hover{background:#f8f9fa}
.sanity-checks{background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:15px;margin-top:20px}
.sanity-checks h4{color:#856404;margin-bottom:10px}
.sanity-check-item{display:flex;justify-content:space-between;margin-bottom:5px;font-size:.9rem}
.help-text{font-size:.8rem;color:#6c757d;margin-top:5px}
.error-message{background:#f8d7da;color:#721c24;padding:10px;border-radius:6px;margin-top:10px;font-size:0.9rem}
.success-message{background:#d4edda;color:#155724;padding:10px;border-radius:6px;margin-top:10px;font-size:0.9rem}
@media (max-width:768px){.main-content{grid-template-columns:1fr}.input-row{grid-template-columns:1fr}.scenarios-grid{grid-template-columns:1fr}.header h1{font-size:2rem}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Professional DCF Valuation Model</h1>
    <p>Complete Goldman Sachs-Style Stock Analysis with Live Financial Data</p>
  </div>

  <div class="main-content">
    <div class="input-column">
      <!-- Ticker Lookup Section -->
      <div class="input-section">
        <h2 class="section-title">📊 Ticker Lookup</h2>
        <div class="input-group">
          <label for="ticker-input">Enter Stock Ticker</label>
          <input id="ticker-input" type="text" placeholder="e.g., AAPL, MSFT, GOOGL, TSLA" maxlength="10">
        </div>
        <button class="fetch-btn" onclick="fetchFinancialData()" id="fetch-button">
          <span class="btn-text">Fetch Financial Data</span>
          <div class="loader" id="api-loader"></div>
        </button>
        <div class="help-text">Fetches the latest TTM financial data automatically from Financial Modeling Prep API</div>
        <div id="fetch-status"></div>
      </div>

      <!-- Company & Financial Data -->
      <div class="input-section">
        <h2 class="section-title">💼 Company & Financial Data</h2>
        <div class="input-group">
          <label for="company-name">Company Name</label>
          <input id="company-name" type="text" placeholder="Will auto-populate from API" readonly>
        </div>
        <div class="input-row">
          <div class="input-group">
            <label for="current-price">Current Stock Price ($)</label>
            <input id="current-price" type="number" step="0.01" placeholder="e.g., 150.00">
          </div>
          <div class="input-group">
            <label for="shares-outstanding">Shares Outstanding</label>
            <div style="display:flex;gap:10px">
              <input id="shares-outstanding" type="number" step="0.01" placeholder="e.g., 15.4" style="flex:2">
              <select id="shares-unit" style="flex:1">
                <option value="million">Million</option>
                <option value="billion" selected>Billion</option>
              </select>
            </div>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group">
            <label for="current-revenue">Annual Revenue (TTM)</label>
            <div style="display:flex;gap:10px">
              <input id="current-revenue" type="number" step="0.1" placeholder="e.g., 394.3" style="flex:2">
              <select id="revenue-unit" style="flex:1">
                <option value="million">Million</option>
                <option value="billion" selected>Billion</option>
              </select>
            </div>
          </div>
          <div class="input-group">
            <label for="free-cash-flow">Free Cash Flow (TTM)</label>
            <div style="display:flex;gap:10px">
              <input id="free-cash-flow" type="number" step="0.1" placeholder="e.g., 99.5" style="flex:2">
              <select id="fcf-unit" style="flex:1">
                <option value="million">Million</option>
                <option value="billion" selected>Billion</option>
              </select>
            </div>
            <div class="help-text">Uses actual FCF from financial statements (more accurate than calculated)</div>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group">
            <label for="total-debt">Total Debt</label>
            <div style="display:flex;gap:10px">
              <input id="total-debt" type="number" step="0.1" placeholder="e.g., 95.3" style="flex:2">
              <select id="debt-unit" style="flex:1">
                <option value="million">Million</option>
                <option value="billion" selected>Billion</option>
              </select>
            </div>
          </div>
          <div class="input-group">
            <label for="cash-equivalents">Cash & Equivalents</label>
            <div style="display:flex;gap:10px">
              <input id="cash-equivalents" type="number" step="0.1" placeholder="e.g., 29.1" style="flex:2">
              <select id="cash-unit" style="flex:1">
                <option value="million">Million</option>
                <option value="billion" selected>Billion</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Growth & Valuation Assumptions -->
      <div class="input-section">
        <h2 class="section-title">📈 Growth & Valuation Assumptions</h2>
        <div class="input-row">
          <div class="input-group">
            <label for="revenue-growth-1-5">Revenue Growth Years 1-5 (%)</label>
            <input id="revenue-growth-1-5" type="number" step="0.1" placeholder="e.g., 8">
            <div class="help-text">Near-term growth rate - use analyst consensus or your estimate</div>
          </div>
          <div class="input-group">
            <label for="revenue-growth-6-10">Revenue Growth Years 6-10 (%)</label>
            <input id="revenue-growth-6-10" type="number" step="0.1" placeholder="e.g., 4">
            <div class="help-text">Mature growth rate - typically 3-6% for established companies</div>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group">
            <label for="terminal-growth">Terminal Growth Rate (%)</label>
            <input id="terminal-growth" type="number" step="0.1" value="2.5">
            <div class="help-text">Long-term GDP growth rate (usually 2-3%)</div>
          </div>
          <div class="input-group">
            <label for="discount-rate">Discount Rate / WACC (%)</label>
            <input id="discount-rate" type="number" step="0.1" value="9.0">
            <div class="help-text">Company's cost of capital (8-12% typical for large companies)</div>
          </div>
        </div>
        <button class="calculate-btn" onclick="calculateDCF()">🚀 Calculate DCF Valuation</button>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section">
      <h2 class="section-title">💰 Valuation Results</h2>
      
      <!-- Scenario Tabs -->
      <div class="scenario-tabs">
        <div class="scenario-tab active" onclick="showScenario('base', this)">Base Case</div>
        <div class="scenario-tab" onclick="showScenario('bull', this)">Bull Case</div>
        <div class="scenario-tab" onclick="showScenario('bear', this)">Bear Case</div>
      </div>
      
      <div id="base-scenario" class="scenario-content active">
        <div id="results-container">
          <div class="result-item">
            <span class="result-label">Free Cash Flow (TTM)</span>
            <span class="result-value" id="current-fcf">$0M</span>
          </div>
          <div class="result-item">
            <span class="result-label">Enterprise Value</span>
            <span class="result-value" id="enterprise-value">$0M</span>
          </div>
          <div class="result-item">
            <span class="result-label">Less: Net Debt</span>
            <span class="result-value" id="net-debt">$0M</span>
          </div>
          <div class="result-item">
            <span class="result-label">Equity Value</span>
            <span class="result-value" id="equity-value">$0M</span>
          </div>
        </div>
        
        <div class="valuation-summary" id="valuation-summary" style="display:none">
          <h3>Fair Value Per Share</h3>
          <div class="price" id="fair-value">$0.00</div>
          <div id="vs-current-price" style="margin-top:10px;font-size:1rem"></div>
        </div>
      </div>
      
      <!-- Scenario Grid -->
      <div class="scenarios-grid" id="scenarios-grid" style="display:none">
        <div class="scenario-result">
          <h4>Bear Case</h4>
          <div class="value" id="bear-value">$0</div>
        </div>
        <div class="scenario-result">
          <h4>Base Case</h4>
          <div class="value" id="base-value">$0</div>
        </div>
        <div class="scenario-result">
          <h4>Bull Case</h4>
          <div class="value" id="bull-value">$0</div>
        </div>
      </div>
      
      <!-- Sanity Checks -->
      <div class="sanity-checks" id="sanity-checks" style="display:none">
        <h4>📋 Valuation Sanity Checks</h4>
        <div class="sanity-check-item">
          <span>Implied P/FCF Ratio:</span>
          <span id="implied-pe">-</span>
        </div>
        <div class="sanity-check-item">
          <span>EV/Revenue Multiple:</span>
          <span id="ev-revenue">-</span>
        </div>
        <div class="sanity-check-item">
          <span>FCF Yield:</span>
          <span id="fcf-yield">-</span>
        </div>
        <div class="sanity-check-item">
          <span>Upside/Downside:</span>
          <span id="upside-downside">-</span>
        </div>
      </div>
      
      <!-- Cash Flow Projections Table -->
      <table class="cash-flow-table" id="cash-flow-table" style="display:none">
        <thead>
          <tr>
            <th style="text-align:left">Year</th>
            <th>Revenue</th>
            <th>FCF</th>
            <th>PV Factor</th>
            <th>Present Value</th>
          </tr>
        </thead>
        <tbody id="cash-flow-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Utility Functions
function toNumber(v) { 
  return (v === null || v === undefined || v === '') ? NaN : Number(v); 
}

function convertToMillions(value, unit) {
  const num = toNumber(value);
  if (!isFinite(num)) return 0;
  return unit === 'billion' ? num * 1000 : num;
}

function isFiniteNumber(x) { 
  return Number.isFinite(x) && !Number.isNaN(x); 
}

function showStatus(message, type = 'info') {
  const statusDiv = document.getElementById('fetch-status');
  statusDiv.className = type === 'error' ? 'error-message' : 'success-message';
  statusDiv.textContent = message;
  setTimeout(() => statusDiv.textContent = '', 5000);
}

// API Integration
async function fetchFinancialData() {
  const ticker = document.getElementById('ticker-input').value.trim().toUpperCase();
  if (!ticker) {
    showStatus('Please enter a stock ticker.', 'error');
    return;
  }

  const loader = document.getElementById('api-loader');
  const btnText = document.querySelector('.fetch-btn .btn-text');
  const fetchButton = document.getElementById('fetch-button');
  
  loader.style.display = 'block';
  btnText.textContent = 'Fetching...';
  fetchButton.disabled = true;

  try {
    // Updated to use Netlify Functions path
    const response = await fetch(`/.netlify/functions/fetch-financials?ticker=${ticker}`);

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `API request failed with status: ${response.status}`);
    }

    const data = await response.json();
    const { profile, cashflow, balanceSheet } = data;

    // Debug: Log all available fields
    console.log('Profile data fields:', Object.keys(profile));
    console.log('Full profile data:', profile);

    // Calculate TTM (sum of last 4 quarters)
    const ttmRevenue = cashflow.reduce((acc, quarter) => acc + (quarter.revenue || 0), 0);
    const ttmFcf = cashflow.reduce((acc, quarter) => acc + (quarter.freeCashFlow || 0), 0);

    // Populate UI fields
    document.getElementById('company-name').value = profile.companyName || 'N/A';
    document.getElementById('current-price').value = profile.price ? profile.price.toFixed(2) : '0';
    
    // Try multiple possible field names for shares outstanding
    let sharesOutstanding = profile.sharesOutstanding || 
                           profile.weightedAverageShsOut || 
                           profile.weightedAverageShsOutDil || 
                           profile.shares || 
                           0;
    
    console.log('Shares outstanding found:', sharesOutstanding);
    
    const sharesInBillion = sharesOutstanding ? (sharesOutstanding / 1_000_000_000).toFixed(2) : '0';
    document.getElementById('shares-outstanding').value = sharesInBillion;
    document.getElementById('shares-unit').value = 'billion';

    document.getElementById('current-revenue').value = (ttmRevenue / 1_000_000_000).toFixed(2);
    document.getElementById('revenue-unit').value = 'billion';
    
    document.getElementById('free-cash-flow').value = (ttmFcf / 1_000_000_000).toFixed(2);
    document.getElementById('fcf-unit').value = 'billion';

    document.getElementById('total-debt').value = (balanceSheet.totalDebt / 1_000_000_000).toFixed(2);
    document.getElementById('debt-unit').value = 'billion';

    document.getElementById('cash-equivalents').value = (balanceSheet.cashAndCashEquivalents / 1_000_000_000).toFixed(2);
    document.getElementById('cash-unit').value = 'billion';

    showStatus(`✅ Successfully loaded data for ${profile.companyName}`, 'success');

  } catch (error) {
    console.error('Error fetching financial data:', error);
    showStatus(`❌ Failed to fetch data: ${error.message}`, 'error');
  } finally {
    loader.style.display = 'none';
    btnText.textContent = 'Fetch Financial Data';
    fetchButton.disabled = false;
  }
}

// UI Functions
function showScenario(scenario, el) {
  document.querySelectorAll('.scenario-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  document.querySelectorAll('.scenario-content').forEach(c => c.classList.remove('active'));
  const target = document.getElementById(scenario + '-scenario');
  if (target) target.classList.add('active');
}

// DCF Calculation
function performDCFCalculation(data) {
  const currentFCF = data.freeCashFlow;
  const fcfMargin = data.currentRevenue > 0 ? currentFCF / data.currentRevenue : 0;
  
  const projections = { revenues: [], fcf: [], pv: [] };
  let totalPVFCF = 0;
  let lastProjectedRevenue = data.currentRevenue;

  // Project 10 years of cash flows
  for (let year = 1; year <= 10; year++) {
    const growthRate = year <= 5 ? data.revenueGrowth15 : data.revenueGrowth610;
    const revenue = lastProjectedRevenue * (1 + growthRate);
    lastProjectedRevenue = revenue;
    
    // Project FCF with slight margin expansion over time
    const fcf = revenue * (fcfMargin + (year * 0.0005)); // More conservative margin expansion
    
    const pvFactor = 1 / Math.pow(1 + data.discountRate, year);
    const pv = fcf * pvFactor;
    
    if (year <= 5) {
      projections.revenues.push(revenue);
      projections.fcf.push(fcf);
      projections.pv.push(pv);
    }
    totalPVFCF += pv;
  }

  // Terminal value calculation
  const lastYearFCF = lastProjectedRevenue * (fcfMargin + (10 * 0.0005));
  const terminalFCF = lastYearFCF * (1 + data.terminalGrowth);
  
  let terminalValue;
  const denom = data.discountRate - data.terminalGrowth;
  if (denom <= 0.001) {
    terminalValue = terminalFCF * 15; // Conservative exit multiple
    console.warn('Terminal growth rate too high. Using 15x exit multiple.');
  } else {
    terminalValue = terminalFCF / denom;
  }
  
  const pvTerminal = terminalValue / Math.pow(1 + data.discountRate, 10);
  const enterpriseValue = totalPVFCF + pvTerminal;
  const netDebt = data.totalDebt - data.cashEquivalents;
  const equityValue = enterpriseValue - netDebt;
  const fairValuePerShare = data.sharesOutstanding !== 0 ? equityValue / data.sharesOutstanding : 0;
  
  projections.terminalFCF = terminalFCF;
  projections.pvTerminal = pvTerminal;

  return {
    currentFCF, enterpriseValue, netDebt, equityValue, fairValuePerShare,
    terminalValue, pvTerminal, totalPVFCF, projections
  };
}

// UI Update Functions
let currentData = {};

function updateResults(results) {
  document.getElementById('current-fcf').textContent = `$${Math.round(results.currentFCF).toLocaleString()}M`;
  document.getElementById('enterprise-value').textContent = `$${Math.round(results.enterpriseValue).toLocaleString()}M`;
  document.getElementById('net-debt').textContent = `$${Math.round(results.netDebt).toLocaleString()}M`;
  document.getElementById('equity-value').textContent = `$${Math.round(results.equityValue).toLocaleString()}M`;
  document.getElementById('fair-value').textContent = `$${results.fairValuePerShare.toFixed(2)}`;
  
  if (isFiniteNumber(currentData.currentPrice) && currentData.currentPrice > 0) {
    const upside = ((results.fairValuePerShare - currentData.currentPrice) / currentData.currentPrice * 100);
    const comparison = upside >= 0 ? `${upside.toFixed(1)}% upside` : `${Math.abs(upside).toFixed(1)}% downside`;
    const el = document.getElementById('vs-current-price');
    el.textContent = `vs Current $${currentData.currentPrice.toFixed(2)}: ${comparison}`;
    el.className = upside >= 0 ? 'positive' : 'negative';
  }
}

function updateScenarioResults(bear, base, bull) {
  document.getElementById('bear-value').textContent = `$${bear.toFixed(2)}`;
  document.getElementById('base-value').textContent = `$${base.toFixed(2)}`;
  document.getElementById('bull-value').textContent = `$${bull.toFixed(2)}`;
}

function updateSanityChecks(results, data) {
  const fcfPerShare = data.sharesOutstanding !== 0 ? (results.currentFCF / data.sharesOutstanding) : 0;
  const impliedPFCF = fcfPerShare !== 0 ? (results.fairValuePerShare / fcfPerShare) : NaN;
  const evRevenue = data.currentRevenue !== 0 ? (results.enterpriseValue / data.currentRevenue) : NaN;
  const marketCap = (data.currentPrice && data.sharesOutstanding) ? (data.currentPrice * data.sharesOutstanding) : NaN;
  const fcfYield = marketCap && marketCap !== 0 ? (results.currentFCF / marketCap) * 100 : NaN;
  const upside = isFiniteNumber(data.currentPrice) && data.currentPrice > 0 ? 
    ((results.fairValuePerShare - data.currentPrice) / data.currentPrice * 100) : NaN;
  
  document.getElementById('implied-pe').textContent = isFiniteNumber(impliedPFCF) ? `${impliedPFCF.toFixed(1)}x` : 'N/A';
  document.getElementById('ev-revenue').textContent = isFiniteNumber(evRevenue) ? `${evRevenue.toFixed(1)}x` : 'N/A';
  document.getElementById('fcf-yield').textContent = isFiniteNumber(fcfYield) ? `${fcfYield.toFixed(1)}%` : 'N/A';
  document.getElementById('upside-downside').textContent = isFiniteNumber(upside) ? `${upside.toFixed(1)}%` : 'N/A';
}

function updateCashFlowTable(projections) {
  const tbody = document.getElementById('cash-flow-body');
  tbody.innerHTML = '';
  
  for (let i = 0; i < 5; i++) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left">Year ${i + 1}</td>
      <td>$${Math.round(projections.revenues[i]).toLocaleString()}M</td>
      <td>$${Math.round(projections.fcf[i]).toLocaleString()}M</td>
      <td>${(1 / Math.pow(1 + currentData.discountRate, i + 1)).toFixed(3)}</td>
      <td>$${Math.round(projections.pv[i]).toLocaleString()}M</td>
    `;
    tbody.appendChild(tr);
  }
  
  const terminalRow = document.createElement('tr');
  terminalRow.style.backgroundColor = '#f1f2f6';
  terminalRow.style.fontWeight = 'bold';
  terminalRow.innerHTML = `
    <td style="text-align:left">Terminal Value</td>
    <td>-</td>
    <td>$${Math.round(projections.terminalFCF).toLocaleString()}M</td>
    <td>${(1 / Math.pow(1 + currentData.discountRate, 10)).toFixed(3)}</td>
    <td>$${Math.round(projections.pvTerminal).toLocaleString()}M</td>
  `;
  tbody.appendChild(terminalRow);
}

// Main DCF Calculation Function
function calculateDCF() {
  const data = {
    companyName: document.getElementById('company-name').value.trim(),
    currentPrice: toNumber(document.getElementById('current-price').value),
    currentRevenue: convertToMillions(toNumber(document.getElementById('current-revenue').value), 
      document.getElementById('revenue-unit').value),
    freeCashFlow: convertToMillions(toNumber(document.getElementById('free-cash-flow').value), 
      document.getElementById('fcf-unit').value),
    totalDebt: convertToMillions(toNumber(document.getElementById('total-debt').value), 
      document.getElementById('debt-unit').value),
    cashEquivalents: convertToMillions(toNumber(document.getElementById('cash-equivalents').value), 
      document.getElementById('cash-unit').value),
    sharesOutstanding: convertToMillions(toNumber(document.getElementById('shares-outstanding').value), 
      document.getElementById('shares-unit').value),
    revenueGrowth15: toNumber(document.getElementById('revenue-growth-1-5').value) / 100,
    revenueGrowth610: toNumber(document.getElementById('revenue-growth-6-10').value) / 100,
    terminalGrowth: toNumber(document.getElementById('terminal-growth').value) / 100,
    discountRate: toNumber(document.getElementById('discount-rate').value) / 100
  };

  // Validation
  const required = [
    {k: 'currentRevenue', v: data.currentRevenue},
    {k: 'freeCashFlow', v: data.freeCashFlow},
    {k: 'discountRate', v: data.discountRate},
    {k: 'sharesOutstanding', v: data.sharesOutstanding},
    {k: 'revenueGrowth15', v: data.revenueGrowth15}
  ];
  
  const missing = required.filter(x => !isFiniteNumber(x.v) || x.v === 0);
  if (missing.length > 0) {
    showStatus(`Please fill required fields: ${missing.map(item => item.k).join(', ')}`, 'error');
    return;
  }
  
  if (data.discountRate <= data.terminalGrowth) {
    showStatus('Discount Rate must be greater than Terminal Growth Rate.', 'error');
    return;
  }

  currentData = data;
  
  // Calculate scenarios
  const base = performDCFCalculation(data);
  
  const bullInput = {
    ...data,
    revenueGrowth15: data.revenueGrowth15 * 1.25,
    revenueGrowth610: data.revenueGrowth610 * 1.25,
    discountRate: data.discountRate * 0.95
  };
  const bull = performDCFCalculation(bullInput);
  
  const bearInput = {
    ...data,
    revenueGrowth15: data.revenueGrowth15 * 0.75,
    revenueGrowth610: data.revenueGrowth610 * 0.75,
    discountRate: data.discountRate * 1.05
  };
  const bear = performDCFCalculation(bearInput);

  // Update UI
  updateResults(base);
  updateScenarioResults(bear.fairValuePerShare, base.fairValuePerShare, bull.fairValuePerShare);
  updateSanityChecks(base, data);
  updateCashFlowTable(base.projections);

  // Show results
  document.getElementById('valuation-summary').style.display = 'block';
  document.getElementById('scenarios-grid').style.display = 'grid';
  document.getElementById('sanity-checks').style.display = 'block';
  document.getElementById('cash-flow-table').style.display = 'table';
  
  showStatus('✅ DCF valuation completed successfully!', 'success');
}

// Load sample data on page load
function loadSampleData() {
  document.getElementById('ticker-input').value = 'AAPL';
  // Set default growth assumptions
  document.getElementById('revenue-growth-1-5').value = '8';
  document.getElementById('revenue-growth-6-10').value = '5';
  document.getElementById('terminal-growth').value = '2.5';
  document.getElementById('discount-rate').value = '9.0';
}

// Initialize page
window.onload = loadSampleData;

// Add Enter key support for ticker input
document.getElementById('ticker-input').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    fetchFinancialData();
  }
});
</script>
</body>
</html>
